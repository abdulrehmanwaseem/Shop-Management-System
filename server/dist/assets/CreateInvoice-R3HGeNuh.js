import{r as g,d as U,x as W,B as w,j as e,F as X,$ as Y,n as Z}from"./vendor-wvIh0B1Y.js";import{F as _,G as V,H as ee,J as te,E as ae,K as se,C as T,S as D,D as ne,T as re,c as Q,I as R}from"./index-DvHrfb7s.js";import{u as le}from"./expensesApi-l4_6av5D.js";import{u as ie}from"./itemsApi-B24hYHel.js";const de=()=>{const[F]=g.useState([]),[f,k]=g.useState(0),j=g.useRef(null),H=U(),O=["ID","Item","Rate","Quantity","Amount"],b=W({resolver:_(),defaultValues:{discount:0,paidAmount:0,freight:0}}),s=b.watch("invoiceTypeId"),A=b.watch("paymentStatusId"),G=b.watch("freight"),q=b.watch("discount"),{data:C}=V(),{data:P}=ee(),{data:l}=ie(),{data:p}=le(),[z]=te(),L=g.useMemo(()=>{var i,u,a;return s===1?(i=p==null?void 0:p.data)==null?void 0:i.map(o=>o.name.trim()):(a=s===3?(u=l==null?void 0:l.data)==null?void 0:u.filter(o=>o.stock>0):l==null?void 0:l.data)==null?void 0:a.map(o=>o.fullName)},[s,p,l]),B=[{data:"itemId",type:"numeric",allowInvalid:!1,strict:!0,readOnly:!0,width:30},{data:"name",type:"autocomplete",source:L,strict:!0,allowInvalid:!1},{data:"rate",type:"numeric",numericFormat:{pattern:"0,0.00"},strict:!0,allowInvalid:!1},{data:"quantity",type:"numeric",strict:!0,allowInvalid:!1},{data:"amount",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:!0,allowInvalid:!1,strict:!0}],K=async i=>{var u;try{const a=(u=j==null?void 0:j.current)==null?void 0:u.hotInstance,o=a.getData();let N=!0,r=!1;if(o.forEach(n=>{n.every(t=>!t)||n.forEach(t=>{t?N=!1:r=!0})}),N){w.error("Please Add Items in table to submit");return}if(r){w.error("Please Review Table Data");return}const h=a==null?void 0:a.getSourceData().filter(n=>n.name&&n.itemId&&n.rate&&n.quantity&&n.amount);let I=0;if(s===3){const n=new Map(h.map(t=>[t.itemId,t.quantity]));I=l.data.reduce((t,x)=>{const v=n.get(x.id)||0;if(!v)return t;const y=x.purchasePrice*v;return t+y},0)}let{remainingAmount:m,paidAmount:d}=i,c=f+parseInt(G)-parseInt(q);A===1?(m=c-(d||0),d=d||0):A===2?(d=c,m=0):A===3&&(d=0,m=c);const E={...i,amount:f,items:h,finalAmount:c,remainingAmount:m,paidAmount:d,...s===3&&{revenue:parseInt(c)-parseInt(I)}};await z(E).unwrap(),H("/invoices")}catch(a){w.error("An error occurred, try again later"),console.log(a)}},{data:S}=ae({invoiceType:s},{skip:!s}),$=g.useCallback((i,u)=>{var o;const a=(o=j.current)==null?void 0:o.hotInstance;if(u==="edit"||u==="CopyPaste.paste"){i==null||i.forEach(([r,h,I,m])=>{var d;if(h==="name"&&I!==m){const c=m?m.trim():"";if(a.getDataAtCol(1).filter((t,x)=>t&&x!==r).includes(c))a.setDataAtRowProp(r,h,I),w.error("Item already added, please choose a different item.");else{const t=s===1?p==null?void 0:p.data.find(y=>{var M;return((M=y==null?void 0:y.name)==null?void 0:M.trim())===c}):(d=l==null?void 0:l.data)==null?void 0:d.find(y=>y.fullName===c),x=0,v=2;a.setDataAtCell(r,x,t==null?void 0:t.id),s===2?a.setDataAtCell(r,v,t==null?void 0:t.purchasePrice):s===3&&a.setDataAtCell(r,v,t==null?void 0:t.salePrice)}}if((h==="rate"||h==="quantity")&&I!==m){const[c,E,n,t,x]=a.getDataAtRow(r);a.setDataAtCell(r,4,(n||0)*(t||0))}});const N=a==null?void 0:a.getSourceData().filter(r=>Object.keys(r).length>0);k(se(N))}}),J=(i,u)=>{if(!s)return!1};return e.jsx(X,{...b,children:e.jsx("form",{onSubmit:b.handleSubmit(K),children:e.jsxs("div",{className:"space-y-4 ",children:[e.jsxs(T,{className:"space-y-4 shadow-lg",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Invoice"}),e.jsx("hr",{}),e.jsxs("div",{className:"flex flex-col lg:flex-row items-center gap-4",children:[e.jsx(D,{label:"Invoice Type",name:"invoiceTypeId",placeholder:"Enter invoice name",options:C==null?void 0:C.data,filter:!1}),e.jsx(ne,{label:"Invoice Date",name:"date"}),e.jsx(D,{label:"Invoice Name",name:"name",value:"name",isDisable:!s,placeholder:"Enter invoice name",options:S==null?void 0:S.data})]}),e.jsx(re,{label:"Particular",name:"particular",placeholder:"Enter invoice particular"})]}),e.jsxs(T,{className:"space-y-4 max-h-fit shadow-lg",children:[e.jsxs("span",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Invoice Details"}),!s&&e.jsx("p",{className:"text-red-500 font-medium",children:'Please select an "invoice type" to enable the table.'})]}),e.jsx("hr",{}),e.jsx(Y,{data:F,ref:j,beforeChange:J,afterChange:$,colHeaders:O,columns:B,readOnly:!s,stretchH:"all",beforeRefreshDimensions:()=>!1,height:`${Math.min(F.length,10)*24+24}px`,contextMenu:!0,manualColumnResize:!0,manualRowResize:!0,rowHeaders:!0,minRows:10,minSpareRows:1,licenseKey:"non-commercial-and-evaluation"})]}),e.jsxs(T,{className:"space-y-4 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Payment Details"}),e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsxs("span",{className:"text-lg font-semibold",children:["Sub Total: ",Q.format(f)]}),e.jsx("div",{class:"border-l-2 border-slate-500 h-6"}),e.jsxs("span",{className:"text-lg font-semibold",children:["Total Amount:"," ",Q.format(f+parseInt(G||0)-parseInt(q||0))]})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[s===2&&e.jsx(R,{label:"Freight Amount",name:"freight",type:"number",maxLimit:f-1,placeholder:"Enter freight amount"}),s!==1&&e.jsx(R,{label:"Discount Amount",name:"discount",type:"number",maxLimit:f-1,placeholder:"Enter discount amount"}),e.jsx(D,{label:"Payment Status",name:"paymentStatusId",placeholder:"Enter invoice name",options:P==null?void 0:P.data,filter:!1}),A===1?e.jsx(R,{label:"Paid Amount",name:"paidAmount",type:"number",maxLimit:f-1,placeholder:"Enter paid amount"}):null]}),e.jsx(Z,{label:"Submit",raised:!0,className:"w-full",size:"small",type:"submit"})]})]})})})};export{de as default};
