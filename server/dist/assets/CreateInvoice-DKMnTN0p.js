import{r as g,d as K,w as J,B as A,j as e,F as L,_,m as $}from"./vendor-CUfTd-uA.js";import{B as U,E as W,F as X,G as Y,H as Z,J as V,C as T,S as R,D as ee,T as te,c as ae,I as se}from"./index-DqSSY3zI.js";import{u as ne}from"./expensesApi-Dj-lGWlh.js";import{u as le}from"./itemsApi-CcFUffY0.js";const ue=()=>{const[D]=g.useState([]),[f,G]=g.useState(0),I=g.useRef(null),q=K(),M=["ID","Item","Rate","Quantity","Amount"],C=J({resolver:U()}),s=C.watch("invoiceTypeId"),N=C.watch("paymentStatusId"),{data:P}=W(),{data:S}=X(),{data:i}=le(),{data:p}=ne(),[Q]=Y(),k=g.useMemo(()=>{var o,u,t;return s===1?(o=p==null?void 0:p.data)==null?void 0:o.map(c=>c.name.trim()):(t=s===3?(u=i==null?void 0:i.data)==null?void 0:u.filter(c=>c.stock>0):i==null?void 0:i.data)==null?void 0:t.map(c=>c.fullName)},[s,p,i]),H=[{data:"itemId",type:"numeric",allowInvalid:!1,strict:!0,readOnly:!0,width:30},{data:"name",type:"autocomplete",source:k,strict:!0,allowInvalid:!1},{data:"rate",type:"numeric",numericFormat:{pattern:"0,0.00"},strict:!0,allowInvalid:!1},{data:"quantity",type:"numeric",strict:!0,allowInvalid:!1},{data:"amount",type:"numeric",numericFormat:{pattern:"0,0.00"},readOnly:!0,allowInvalid:!1,strict:!0}],O=async o=>{var u;try{const t=(u=I==null?void 0:I.current)==null?void 0:u.hotInstance,c=t.getData();let w=!0,n=!1;if(c.forEach(l=>{l.every(r=>!r)||l.forEach(r=>{r?w=!1:n=!0})}),w){A.error("Please Add Items in table to submit");return}if(n){A.error("Please Review Table Data");return}const h=t==null?void 0:t.getSourceData().filter(l=>l.name&&l.itemId&&l.rate&&l.quantity&&l.amount);let x=0;if(s===3){const l=new Map(h.map(r=>[r.itemId,r.quantity]));x=i.data.reduce((r,a)=>{const y=l.get(a.id)||0;if(!y)return r;const b=a.purchasePrice*y;return r+b},0)}let{remainingAmount:m,paidAmount:d}=o;N===1?(m=f-(d||0),d=d||0):N===2?(d=f,m=0):N===3&&(d=0,m=f);const v={...o,amount:f,items:h,remainingAmount:m,paidAmount:d,...s===3&&{revenue:parseInt(f)-parseInt(x)}};await Q(v).unwrap(),q("/invoices")}catch(t){A.error("An error occurred, try again later"),console.log(t)}},{data:E}=Z({invoiceType:s},{skip:!s}),z=g.useCallback((o,u)=>{var c;const t=(c=I.current)==null?void 0:c.hotInstance;if(u==="edit"||u==="CopyPaste.paste"){o==null||o.forEach(([n,h,x,m])=>{var d;if(h==="name"&&x!==m){const v=m?m.trim():"";if(t.getDataAtCol(1).filter((a,y)=>a&&y!==n).includes(v))t.setDataAtRowProp(n,h,x),A.error("Item already added, please choose a different item.");else{const a=s===1?p==null?void 0:p.data.find(j=>{var F;return((F=j==null?void 0:j.name)==null?void 0:F.trim())===v}):(d=i==null?void 0:i.data)==null?void 0:d.find(j=>j.fullName===v),y=0,b=2;t.setDataAtCell(n,y,a==null?void 0:a.id),s===2?t.setDataAtCell(n,b,a==null?void 0:a.purchasePrice):s===3&&t.setDataAtCell(n,b,a==null?void 0:a.salePrice)}}if((h==="rate"||h==="quantity")&&x!==m){const[v,l,r,a,y]=t.getDataAtRow(n);t.setDataAtCell(n,4,(r||0)*(a||0))}});const w=t==null?void 0:t.getSourceData().filter(n=>Object.keys(n).length>0);G(V(w))}}),B=(o,u)=>{if(!s)return!1};return e.jsx("div",{children:e.jsx(L,{...C,children:e.jsx("form",{onSubmit:C.handleSubmit(O),children:e.jsxs("div",{className:"space-y-4 ",children:[e.jsxs(T,{className:"space-y-4 shadow-lg",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Invoice"}),e.jsx("hr",{}),e.jsxs("div",{className:"flex flex-col lg:flex-row items-center gap-4",children:[e.jsx(R,{label:"Invoice Type",name:"invoiceTypeId",placeholder:"Enter invoice name",options:P==null?void 0:P.data,filter:!1}),e.jsx(ee,{label:"Invoice Date",name:"date"}),e.jsx(R,{label:"Invoice Name",name:"name",value:"name",getKey:"name",isDisable:!s,placeholder:"Enter invoice name",options:E==null?void 0:E.data})]}),e.jsx(te,{label:"Particular",name:"particular",placeholder:"Enter invoice particular"})]}),e.jsxs(T,{className:"space-y-4 max-h-fit shadow-lg",children:[e.jsxs("span",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Invoice Details"}),!s&&e.jsx("p",{className:"text-red-500 font-medium",children:'Please select an "invoice type" to enable the table.'})]}),e.jsx("hr",{}),e.jsx(_,{data:D,ref:I,beforeChange:B,afterChange:z,colHeaders:M,columns:H,readOnly:!s,stretchH:"all",beforeRefreshDimensions:()=>!1,height:`${Math.min(D.length,10)*24+24}px`,contextMenu:!0,manualColumnResize:!0,manualRowResize:!0,rowHeaders:!0,minRows:10,minSpareRows:1,licenseKey:"non-commercial-and-evaluation"})]}),e.jsxs(T,{className:"space-y-4 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Payment Details"}),e.jsxs("span",{className:"text-lg font-semibold",children:["Total Amount: ",ae.format(f)]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx(R,{label:"Payment Status",name:"paymentStatusId",placeholder:"Enter invoice name",options:S==null?void 0:S.data,filter:!1}),N===1&&f!==0?e.jsx(se,{label:"Paid Amount",name:"paidAmount",type:"number",maxLimit:f-1,placeholder:"Enter paid amount"}):null]}),e.jsx($,{label:"Submit",raised:!0,className:"w-full",size:"small",type:"submit"})]})]})})})})};export{ue as default};
